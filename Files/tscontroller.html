<!DOCTYPE html>
<html>
	<head> 
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.4.4.min.js"></script>
		<script type="text/javascript" src="js/overwolfUtils.js"></script>
		<script type="text/javascript" src="js/censusSOE.js"></script>
		<script type="text/javascript" src="js/jquery.caret.js"></script>
		<script type="text/javascript" src="js/jquery-latest.js"></script>
		<script 					   src="js/jstree.min.js"></script>
		<script type="text/javascript" src="js/jquery.layout-latest.js"></script>
		<link rel="stylesheet" href="js/themes/default/style.css" />
		<link rel="stylesheet" href="style.css" />
	</head>
    <script type="text/javascript">
		var serverId;
		var channelId;
		var clientId;
		
        function plugin0()
        {
            return document.getElementById('plugin0');
        }
        plugin = plugin0;
        function addEvent(obj, name, func)
        {
            if (obj.attachEvent) {
                obj.attachEvent("on"+name, func);
            } else {
                obj.addEventListener(name, func, false); 
            }
        }
        
        function load()
        {
		
        }
		
		function joinRoom(roomId){
			if (typeof roomId === "undefined") {
				return;
			}
			if(roomId !== channelId){
				plugin().switchChannel({ 	"serverId" : serverId, 
											"channelId" : roomId,
											"password" : "",
											"clientId" : clientId}, function(error){
					if(error.success){
						channelId = roomId;
						writeToArea("Server",  "Room changed");
						getClients();
					}else{
						writeToArea("Server",  error.error);
						jQuery("#jstree_demo_div").jstree("deselect_node", roomId);
					}
					setTimeout(function(){
						jQuery("#jstree_demo_div").jstree("select_node", channelId);
						},100);
				});
			}
		}

		function sendMessage(message){
			if(message.length > 0){
				plugin().sendTextMessage ({ "serverId" : serverId,  "type" : "Channel", 
											"message" : message, "targetId":channelId}, function(error){
					if(!error.success){
						writeToArea("Server",  error.error);
					}
				});		
			}
		}
		
		function writeToArea(origin, message){
			var textArea = $("#textAreaContent");
			if(textArea.html().length >= 2000){
				textArea.html('');
				textArea.append(origin + ": " + message + "\n");
			}else{
				textArea.append(origin + ": " + message + "\n");
				textArea.scrollTop(
					textArea[0].scrollHeight - textArea.height()
				);
			}
		}
		
		function getClients(){
			plugin().getChannelClientList({ "serverId" : serverId, 
											"channelId" : channelId}, function(error, clients){
				for(var i = 0; i < clients.length; i++){
					var client = clients[i];
					client.id = client.clientId;
					client.parent = "#";
					client.text = client.nickname;
				}
				$('#jstree_clients_div').jstree('destroy');
				$('#jstree_clients_div').jstree({ 'core' : {
						'data' : clients
					} });
			});
		}
		
		function getChannels(){
			plugin().getChannels(serverId, function(error, channels){
				for(var i = 0; i < channels.length; i++){
					var channel = channels[i];
					channel.id = channel.channelId;
					if(channel.parentId === "0"){
						channel.parent = "#";
					}else{
						channel.parent = channel.parentId;
					}
					channel.text = channel.channelName;
				}
				
				var scrollPosition = $("#controlBox").scrollTop();
				
				var tree = $("#jstree_demo_div");
				tree.jstree('destroy');
				tree.bind("loaded.jstree", function (event, data) {
					tree.jstree("open_all");
				});			
				tree.jstree({ 'core' : {
						'data' : channels
					} });
				tree.on("changed.jstree", function (e, data) {
					joinRoom(data.selected[0]);
				});
				tree.jstree("select_node", channelId);
				setTimeout(function(){$("#controlBox").scrollTop(scrollPosition);}, 50);	
				setTimeout(function(){joinRoom(channelId);}, 350);
			});
		}
		
		function getServer(callback){
			plugin().getAllServersInfo(function(errorObject,server) {
				channelId = server.channelId;
				callback();
			});
		}
		
        function pluginLoaded() {
            console.log("Plugin loaded!");
			
			plugin().addEventListener("onTextMessageReceived", function(TextMessageDataObject ) {
				var mod = "";
				if(TextMessageDataObject.target == "Client"){
					mod = "(PM)";
				}else  if(TextMessageDataObject.target == "Server"){
					mod = "(Broadcast)";
				}
				writeToArea(TextMessageDataObject.fromClientName + mod, TextMessageDataObject.message);
			});			

			plugin().addEventListener("onServerStatusChange", function(ServerStatusChangeObject ) {	
				writeToArea("Server Status", ServerStatusChangeObject.status);
				getChannels();
			});

			plugin().addEventListener("onActiveServerChanged", function(newServerId) {
				serverId = newServerId;
				getClients();
			});
			
			plugin().addEventListener("onDisconnectedFromClient", function() {
				close();
			});	
			
			plugin().addEventListener("onClientEvent", function(onClientEvent) {
				if(onClientEvent.isOwnClient){
					getServer(function(){getClients();});
				}else{
					getClients();
				}
				writeToArea("Server", onClientEvent.clientName + "-" + onClientEvent.type);
			});

			plugin().addEventListener("onChannelUpdated",function(ChannelObject) {
				getClients();
			});

			plugin().addEventListener("onChannelCreated", function(ChannelObject) {
				getChannels();
			});	

			plugin().addEventListener("onChannelDeleted", function(ChannelDeletedObject) {
				getChannels();
			});		
			
			plugin().addEventListener("onTalkStatusChanged",function(TalkStatusDataObject) {
				if(TalkStatusDataObject.state === "Talk"){
					jQuery("#jstree_clients_div").jstree("select_node", TalkStatusDataObject.clientId);			
				}else if(TalkStatusDataObject.state === "StopTalk"){
					jQuery("#jstree_clients_div").jstree("deselect_node", TalkStatusDataObject.clientId);
				}
			});

			setTimeout(function() {
			
				plugin().init({name: "Overwolf-TeamSpeak-Sample"}, function(result,servers) {
				console.log("result: ",result ,servers);
					
				// no server is connected
				if (servers && !servers.activeServerId)  {
					alert("No TeamSpeak running detected.");
					close();
					/*plugin().connectToServer( { tab :"currentTab", 
												label:"ts3 public server", 
												address :"derpcompany.com", 
												nickName:"CRamsan" },
												function(result,server) {
						console.log("start new connection: ",result , server)
						serverId = server.serverId;
						plugin().getServerInfo(serverId,function(inforesult,serverInfo) {
							if(inforesult.success){
								channelId = serverInfo.channelId;
								clientId = serverInfo.myClientId
								getChannels();
								getClients();
							}else{
								writeToArea("Server: ", "Could not connect, trying again in 5 seconds");
								setTimeout(function(){pluginLoaded()}, 5000);
							}
						});
					});*/
			     } else {
					plugin().getAllServersInfo(function(errorObject,servers) {
						console.log("All servers:" ,result , servers);
						serverId = servers[0].serverId;
						channelId = servers[0].channelId;
						clientId = servers[0].myClientId
						getChannels();
						getClients();
					});
				 }
				});
				
			}, 500);

        }
		$(document).ready(function () {
			$('#layoutContainer').layout({ applyDemoStyles: true });
						
			$("#textAreaInput").keydown(function(event){
				if(event.keyCode == 13){
					sendMessage($("#textAreaInput").val());
				}
			});
			$("#textAreaInput").keyup(function(event){
				if(event.keyCode == 13){
					var textArea = $("#textAreaInput");
					textArea.val('');
					
					var psconsole = $('#textAreaContent');
					psconsole.scrollTop(
						psconsole[0].scrollHeight - psconsole.height()
					);
				}
			});
		});
    </script>
	<body onload="load()">
		<div class="resizeGrip" id="resizeGripTopLeft" onmousedown="dragResize('TopLeft');"></div>
		<div class="resizeGrip" id="resizeGripTop" onmousedown="dragResize('Top');"></div>
		<div class="resizeGrip" id="resizeGripTopRight" onmousedown="dragResize('TopRight');"></div>
		<div class="resizeGrip" id="resizeGripRight" onmousedown="dragResize('Right');"></div>
		<div class="resizeGrip" id="resizeGripBottomRight" onmousedown="dragResize('BottomRight');"></div>
		<div class="resizeGrip" id="resizeGripBottom" onmousedown="dragResize('Bottom');"></div>
		<div class="resizeGrip" id="resizeGripBottomLeft" onmousedown="dragResize('BottomLeft');"></div>
		<div class="resizeGrip" id="resizeGripLeft" onmousedown="dragResize('Left');"></div>

		<div id="content" >
			<object id="plugin0" type="application/x-overwolfteamspeakplugin" class="invisible" >
				<param name="onload" value="pluginLoaded" />
			</object>
			<div id="layoutContainer" style="height: 100%;">	
				<div id="usersBox" class="ui-layout-center" onmousedown="dragMove();">
					<div id="jstree_clients_div" ></div>
					<div class="windowController">
						<button type="button" style="color: black; float:left; width: 67px;" onclick="minimizeWindows()">Minimize</button>
						<button type="button" style="color: black; float:left; width: 67px;" onclick="closeWindows()">Close</button>
					</div>	
				</div>
				<div id="chatBox" class="ui-layout-south">
					<textarea id="textAreaContent" disabled style="width: 100%; height: 67px; resize: none;" maxlength="2000"></textarea>
					<textarea id="textAreaInput" rows="1" style="width: 100%; resize: none; float:left;" maxlength="200"></textarea>
				</div>
				<div id="controlBox" class="ui-layout-east">
					<div onmousedown="dragMove();" id="jstree_demo_div"></div>					
				</div>
			</div>
		</div>
	</body>
</html>
